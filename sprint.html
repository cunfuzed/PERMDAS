<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>40 equations SPRINT</title>
    <link href="style.css" rel="stylesheet" type="text/css" />

    <style>
      .answer_box{
        display: block;
        width: 400px;
        height: 100px;
        margin: 50px auto 0;
        font-size: 20px;
        text-align: center;
      }
      .header{
        text-align: center;
        font-size: 50px;
        font-family: "Courier New", Courier, monospace;
      }
      .equation{
        margin-top: 100px;
        text-align: center;
        margin-right: 350px;
        font-family: "Courier New", Courier, monospace;
      }
      .counter{
        font-size: 20px;
        position: absolute;
        top: 400px;
        right: 255px;
        font-family: "Courier New", Courier, monospace;
      }
      .timer{
        font-family: "Courier New", Courier, monospace;
      }
      .highscore{
        position: absolute;
        font-family: "Courier New", Courier, monospace;
        top: 60px;
        right: 16%;
        font-size: 25px;
      }
      .aps{
        font-size: 20px;
        position: absolute;
        top: 375px;
        right: 260px;
        font-family: "Courier New", Courier, monospace;
      }
      .reading-time{
        font-size: 20px;
        position: absolute;
        top: 325px;
        right: 260px;
        font-family: "Courier New", Courier, monospace;
      }
      .typing-time{
        font-size: 20px;
        position: absolute;
        top: 350px;
        right: 260px;
        font-family: "Courier New", Courier, monospace;
      }
      .box{
        position: fixed;
        top: 0;
        left: 10%;
        width: 80%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        z-index: -1;
      }
      body {
        background-image: url("https://images.fineartamerica.com/images-medium-large-5/sunset-over-mountain-layers-maya-karkalicheva.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        color: white;
      }
      .back{
        backdrop-filter: blur(10px);
        padding: 15px 50px 15px 80px;
        clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 0% 100%);
        position: absolute;
        color: red;
        background-color:rgba(0, 0, 0, 0.3);
        top: 0px;
        left: -50px;
        font-size: 30px;
        border: none; 
        cursor: pointer;
        font-family: "Courier New", Courier, monospace;
        transition: all 0.3s ease;
      }
      .back:hover{
        transform: translateX(50px)
      }
    </style>
  </head>

  <body>
    <div class = "box"></div>
    <h1 class = "header" id = "header" >40 Equation <span style = "color:yellow">Sprint</span></h1>
    <p class="highscore" id="highscore">Best Time: --</p>
    <p class = "equation" id="equation" style="margin-left:250px; font-size:40px;"></p>
    <p class="timer" id="timer" style="text-align:center; font-size:30px;">
      Time: 0.00s
    </p>
    <p class = "reading-time" id = "reading-time">Avg Read: 0.00s</p>
    <p class = "typing-time" id = "typing-time">Avg Type: 0.00s</p>
    <p class = "aps" id = "aps">APS: __.__</p>

    <textarea class = "answer_box" id = "answer_box"></textarea>
    <p class="counter" id="counter"> Equations Left: 40 </p>
    <a href = "modes.html"><button class = "back">Modes</button></a>

    <script>



      const API = "https://family-complete-walked-borders.trycloudflare.com";
      
      function submitFinalScore(finalTime) {
        const username = localStorage.getItem("username");
      
        if (!username) {
          console.error("No username found in localStorage");
          return;
        }
      
        fetch(API + "/score", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: username,
            score: finalTime
          })
        })
        .then(res => res.json())
        .then(data => {
          console.log("Score submitted:", data.user);
        })
        .catch(err => console.error("Score submit failed:", err));
      }

      //high scores:
      let bestTime = localStorage.getItem("bestTime");
      if (bestTime !== null) {
         bestTime = Number(bestTime);
      }


      //let vars
      let firstNum = Math.floor(Math.random() * 10);
      let sum = Math.floor(Math.random() * 10);
      let secondNum = sum-firstNum;
      let equationsLeft = 40;
      let equationsCompleted = 0;
      let startTime = Date.now();
      let timerInterval;
      let timerStarted = false;
      let problemPhase = "not started";
      let phaseStartTime = Date.now();
      let totalReadingTime = 0;
      let totalTypingTime = 0;
      let mode = "equations";
      let mistakes = 0;
      let keypresses = 0;

      //getting keybinds
      let answerQuestion = localStorage.getItem("answer_question");
      let resetGame = localStorage.getItem("reset_game");

      //getting stats
      let totalGames = localStorage.getItem("totalGames");
      let totalEquations = localStorage.getItem("totalEquations");
      
      //const vars
      const timerElement = document.getElementById("timer");
      const equationElement = document.getElementById("equation");
      const answerBox = document.getElementById("answer_box");
      const counterElement = document.getElementById("counter");
      const highscoreElement = document.getElementById("highscore");
      const apsElement = document.getElementById("aps");
      const readingTimeElement = document.getElementById("reading-time");
      const typingTimeElement = document.getElementById("typing-time");
      const backGround = document.getElementById("background");
      const header = document.getElementById("header");

      //functions
      function updateAPS() {
        const elapsed = (Date.now() - startTime) / 1000;
        if (elapsed > 0) {
          const aps = equationsCompleted / elapsed;
          apsElement.textContent = `APS: ${aps.toFixed(2)}`;
        }

        // Update average reading and typing times
        if (equationsCompleted > 0) {
          const avgReading = (totalReadingTime / equationsCompleted / 1000).toFixed(2);
          const avgTyping = (totalTypingTime / equationsCompleted / 1000).toFixed(2);
          readingTimeElement.textContent = `Avg Read: ${avgReading}s`;
          typingTimeElement.textContent = `Avg Type: ${avgTyping}s`;
        }
      }
      function updateEquation() {
        equationElement.textContent = `${firstNum} + ${secondNum} =`;
      }
      function findAnswer() {
        return firstNum + secondNum;
      }
      function switchPhase(newPhase) {
        // Record time spent in current phase
        const phaseElapsed = Date.now() - phaseStartTime;

        if (problemPhase === "reading") {
          totalReadingTime += phaseElapsed;
        } else if (problemPhase === "typing") {
          totalTypingTime += phaseElapsed;
        }

        // Switch to new phase
        problemPhase = newPhase;
        phaseStartTime = Date.now();
      }
      function startTimer() {
        if (timerStarted) return;
        timerStarted = true;
        startTime = Date.now();
        phaseStartTime = startTime;
        switchPhase("reading");
        timerInterval = setInterval(() => {
          const elapsed = (Date.now() - startTime) / 1000;
          timerElement.textContent = `Time: ${elapsed.toFixed(2)}s`;
          updateAPS();
        }, 50); // updates 20 times per second

      }
      function updateHighscoreDisplay() {
        if (bestTime !== null) {
          highscoreElement.textContent = `Best Time: ${bestTime.toFixed(2)}s`;
        }
      }
      function unlockAchievement(achievementId) {
        let unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
        if (!unlockedAchievements.includes(achievementId)) {
          unlockedAchievements.push(achievementId);
          localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedAchievements));
        }
      }

      updateEquation();
      updateHighscoreDisplay();

      let paused = false;
      //checking for reset
      document.addEventListener("keydown", (event) =>{
        if (event.key === resetGame){
          location.reload();
          event.preventDefault();
        }
      });

      //stuff for text area/answer box
      answerBox.addEventListener("keyup", (event) => {
        keypresses++;
        if (paused) return;

        // Switch to typing phase when user starts typing
        if (problemPhase === "reading") {
          switchPhase("typing");
        }

        if (!timerStarted){
          startTimer();
        }

        if (event.key === answerQuestion) {
          event.preventDefault();

          if (Number(answerBox.value) === findAnswer()) {
            let equationsComp = parseInt(totalEquations || 0) + 1;
            localStorage.setItem("totalEquations", equationsComp.toString());
            totalEquations = equationsComp.toString();

            firstNum = Math.floor(Math.random() * 10);
            secondNum = Math.floor(Math.random() * 10);
            switchPhase("reading");
            updateEquation();
            equationsLeft--;
            equationsCompleted++;
            counterElement.textContent = `Equations Left: ${equationsLeft}`;

            //0-int achievement
            if(keypresses === 1){
              unlockAchievement("zero_input");
            }

            if (equationsLeft <= 0) {
              clearInterval(timerInterval);

              // adding total games
              let gamesPlayed = parseInt(totalGames || 0) + 1;
              localStorage.setItem("totalGames", gamesPlayed.toString());

              // Record final phase time
              const phaseElapsed = Date.now() - phaseStartTime;
              if (problemPhase === "typing") {
                totalTypingTime += phaseElapsed;
              }

              //high score stuff
              const finalTime = (Date.now() - startTime) / 1000;

              if (bestTime === null || finalTime < bestTime) {
                bestTime = finalTime;
                localStorage.setItem("bestTime", bestTime.toString());
                updateHighscoreDisplay();
              }

              // Display stats
              const avgReadingTime = (totalReadingTime / equationsCompleted / 1000).toFixed(2);
              const avgTypingTime = (totalTypingTime / equationsCompleted / 1000).toFixed(2);

              //achievements
              if(finalTime <= 40){unlockAchievement("speed_demon");}
              if(mistakes <= 0){unlockAchievement("perfect_score");}
              if(avgReadingTime < 0.8){unlockAchievement("brain");}
              if(avgTypingTime < 0.2){unlockAchievement("twitch");}
              unlockAchievement("first_win");

              equationElement.innerHTML = `Sprint complete!<br>Final Time: ${finalTime}s`;
              answerBox.disabled = true;
              answerBox.value = "";
              
              
              submitFinalScore(finalTime);
              
              
              return;
            }

          } else {
            mistakes++;
            paused = true;
            equationElement.innerHTML = "Wrong answer<br>3 second penalty";
            setTimeout(() => {
              paused = false;
              updateEquation();
            }, 3000);
          }
          keypresses = 0;
          answerBox.value = "";
        }
      });

      window.addEventListener('load', () => {
        const savedBg = localStorage.getItem('customBackground');
        if (savedBg) {
          document.body.style.backgroundImage = `url('${savedBg}')`;
        }
      });
    </script>

  </body>

</html>
